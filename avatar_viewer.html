<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Avatar Viewer</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body {
      margin: 0;
      overflow: hidden;
      background: #000;
      font-family: Arial, sans-serif;
    }
    
    #container {
      width: 100vw;
      height: 100vh;
    }
    
    #loading {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      color: white;
      font-size: 18px;
      z-index: 1000;
      text-align: center;
    }
    
    .spinner {
      border: 4px solid rgba(255, 255, 255, 0.3);
      border-radius: 50%;
      border-top: 4px solid white;
      width: 40px;
      height: 40px;
      animation: spin 1s linear infinite;
      margin: 0 auto 20px;
    }
    
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    
    #error {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      color: #ff4444;
      font-size: 16px;
      z-index: 1001;
      display: none;
      text-align: center;
      padding: 20px;
    }
  </style>
</head>
<body>
  <div id="loading">
    <div class="spinner"></div>
    <div>Loading Avatar...</div>
  </div>
  
  <div id="error"></div>
  
  <div id="container"></div>

  <script type="importmap">
    {
      "imports": {
        "three": "https://cdn.jsdelivr.net/npm/three@0.150.1/build/three.module.js",
        "three/addons/": "https://cdn.jsdelivr.net/npm/three@0.150.1/examples/jsm/"
      }
    }
  </script>

  <script type="module">
    import * as THREE from 'three';
    import { GLTFLoader } from 'three/addons/loaders/GLTFLoader.js';
    import { FBXLoader } from 'three/addons/loaders/FBXLoader.js';

    console.log('ðŸŽ¬ Avatar Viewer initializing...');

    // Get URL parameters
    const urlParams = new URLSearchParams(window.location.search);
    const modelUrl = urlParams.get('modelUrl');
    
    console.log('ðŸ“¦ Model URL:', modelUrl);

    if (!modelUrl) {
      showError('No model URL provided');
      throw new Error('Model URL is required');
    }

    // Setup scene
    const container = document.getElementById('container');
    const scene = new THREE.Scene();
    scene.background = new THREE.Color(0x000000);

    // Camera
    const camera = new THREE.PerspectiveCamera(
      45,
      window.innerWidth / window.innerHeight,
      0.1,
      1000
    );
    camera.position.set(0, 1.6, 3);
    camera.lookAt(0, 1, 0);

    // Renderer
    const renderer = new THREE.WebGLRenderer({ antialias: true });
    renderer.setPixelRatio(window.devicePixelRatio);
    renderer.setSize(window.innerWidth, window.innerHeight);
    renderer.outputEncoding = THREE.sRGBEncoding;
    renderer.shadowMap.enabled = true;
    container.appendChild(renderer.domElement);

    // Lights
    const ambientLight = new THREE.AmbientLight(0xffffff, 0.8);
    scene.add(ambientLight);

    const directionalLight = new THREE.DirectionalLight(0xffffff, 1.0);
    directionalLight.position.set(5, 10, 7.5);
    directionalLight.castShadow = true;
    scene.add(directionalLight);

    const directionalLight2 = new THREE.DirectionalLight(0xffffff, 0.5);
    directionalLight2.position.set(-5, 5, -5);
    scene.add(directionalLight2);

    // Loaders
    const gltfLoader = new GLTFLoader();
    const fbxLoader = new FBXLoader();

    let mixer;
    let avatar;

    // Show error function
    function showError(message) {
      document.getElementById('loading').style.display = 'none';
      const errorDiv = document.getElementById('error');
      errorDiv.textContent = message;
      errorDiv.style.display = 'block';
      console.error('âŒ', message);
    }

    // Load avatar model
    console.log('ðŸ“¥ Loading GLB model...');
    
    gltfLoader.load(
      modelUrl,
      function (gltf) {
        console.log('âœ… GLB loaded successfully');
        
        avatar = gltf.scene;
        scene.add(avatar);

        // Center the model
        const box = new THREE.Box3().setFromObject(avatar);
        const center = box.getCenter(new THREE.Vector3());
        avatar.position.sub(center);
        avatar.position.y = 0;

        document.getElementById('loading').style.display = 'none';

        // Load animation
        const animationUrl = './F_Standing_Idle_Variations_003.fbx';
        console.log('ðŸŽ­ Loading animation:', animationUrl);

        fbxLoader.load(
          animationUrl,
          function (fbx) {
            console.log('âœ… Animation loaded');
            
            if (avatar.children && avatar.children[0]) {
              mixer = new THREE.AnimationMixer(avatar.children[0]);
              const clip = fbx.animations[0];

              // Fix position scale
              clip.tracks.forEach((track) => {
                if (track.name.includes('position')) {
                  for (let i = 0; i < track.values.length; i++) {
                    track.values[i] = track.values[i] / 100;
                  }
                }
              });

              const action = mixer.clipAction(clip);
              action.play();
              
              console.log('ðŸŽ¬ Animation playing');
            }
          },
          function (progress) {
            console.log('Animation loading:', (progress.loaded / progress.total * 100).toFixed(2) + '%');
          },
          function (error) {
            console.warn('âš ï¸ Animation load error:', error);
            // Don't show error - avatar still visible without animation
          }
        );
      },
      function (progress) {
        const percent = (progress.loaded / progress.total * 100).toFixed(2);
        console.log('GLB loading:', percent + '%');
      },
      function (error) {
        console.error('âŒ GLB load error:', error);
        showError('Failed to load avatar model. Please check the URL and try again.');
      }
    );

    // Animation loop
    const clock = new THREE.Clock();
    
    function animate() {
      requestAnimationFrame(animate);

      const delta = clock.getDelta();
      if (mixer) {
        mixer.update(delta);
      }

      renderer.render(scene, camera);
    }
    
    animate();

    // Handle window resize
    window.addEventListener('resize', () => {
      camera.aspect = window.innerWidth / window.innerHeight;
      camera.updateProjectionMatrix();
      renderer.setSize(window.innerWidth, window.innerHeight);
    });

    console.log('âœ… Viewer initialized');
  </script>
</body>
</html>

